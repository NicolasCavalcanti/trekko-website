<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S816P190VN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-S816P190VN');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2482023752745520"
         crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-2482023752745520">
    

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Trekko</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .profile-avatar {
            background: linear-gradient(135deg, #059669, #047857);
        }
        .stat-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }
        .guide-avatar {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="https://www.trekko.com.br/" class="text-2xl font-bold text-green-600">Trekko</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="https://www.trekko.com.br/" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">In√≠cio</a>
                        <a href="trilhas.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Trilhas</a>
                        <a href="guias.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Guias</a>
                        <a href="sobre.html" class="text-gray-500 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Sobre</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 text-gray-700 hover:text-green-600">
                            <span id="userName" class="font-medium">Carregando...</span>
                            <span class="text-sm">‚ñº</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Profile Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                <!-- Avatar -->
                <div id="profileAvatar" class="profile-avatar w-24 h-24 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                    <span id="avatarInitials">--</span>
                </div>
                
                <!-- Profile Info -->
                <div class="flex-1 text-center md:text-left">
                    <h1 id="profileName" class="text-2xl font-bold text-gray-900 mb-2">Carregando...</h1>
                    <p id="profileEmail" class="text-gray-600 mb-2">carregando@exemplo.com</p>
                    <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-4">
                        <span id="userTypeBadge" class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">ü•æ Carregando...</span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">‚úì Verificado</span>
                        <span id="cadasturBadge" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium hidden">üìã CADASTUR</span>
                    </div>
                    <p id="profileBio" class="text-gray-700 max-w-2xl">Carregando biografia...</p>
                </div>
                
                <!-- Edit Button -->
                <button onclick="openEditModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium">
                    ‚úèÔ∏è Editar Perfil
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600 mb-2">0</div>
                <div class="text-gray-600" id="stat1Label">Trilhas Realizadas</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600 mb-2">0</div>
                <div class="text-gray-600">Km Percorridos</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600 mb-2">0</div>
                <div class="text-gray-600" id="stat3Label">Guias Contratados</div>
            </div>
            <div class="stat-card rounded-lg p-6 text-center">
                <div id="experienceLevel" class="text-3xl font-bold text-green-600 mb-2">Iniciante</div>
                <div class="text-gray-600">N√≠vel</div>
            </div>
        </div>

        <!-- Content Tabs -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button class="tab-btn border-b-2 border-green-500 py-4 px-1 text-sm font-medium text-green-600" data-tab="atividades">
                        Minhas Atividades
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="favoritos">
                        Favoritos
                    </button>
                    <button class="tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="avaliacoes">
                        Avalia√ß√µes
                    </button>
                </nav>
            </div>

            <!-- Tab Contents -->
            <div class="p-6">
                <div id="atividades" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Minhas Atividades Recentes</h3>
                        <button id="createExpeditionBtn" onclick="openCreateExpeditionModal()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            + Criar Expedi√ß√£o
                        </button>
                    </div>
                    <div id="activitiesContainer" class="text-center py-8">
                        <p class="text-gray-500">Nenhuma atividade registrada ainda.</p>
                        <p id="activitySubtext" class="text-sm text-gray-400 mt-2">Suas atividades aparecer√£o aqui ap√≥s realizar trilhas.</p>
                    </div>

                    <div id="guideExpeditionsSection" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">Expedi√ß√µes</h4>
                            <button type="button" onclick="openCreateExpeditionModal()" class="hidden text-sm font-medium text-green-600 hover:text-green-700" id="secondaryCreateExpeditionBtn">
                                + Nova expedi√ß√£o
                            </button>
                        </div>
                        <div id="guideExpeditionsList" class="space-y-4"></div>
                    </div>
                </div>

                <div id="favoritos" class="tab-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Trilhas Favoritas</h3>
                    <div class="text-center py-8">
                        <p class="text-gray-500">Nenhuma trilha favorita ainda.</p>
                        <p class="text-sm text-gray-400 mt-2">Suas trilhas favoritas aparecer√£o aqui.</p>
                    </div>
                </div>

                <div id="avaliacoes" class="tab-content hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Minhas Avalia√ß√µes</h3>
                    <div class="text-center py-8">
                        <p class="text-gray-500">Nenhuma avalia√ß√£o ainda.</p>
                        <p class="text-sm text-gray-400 mt-2">Suas avalia√ß√µes de trilhas e guias aparecer√£o aqui.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Editar Perfil</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Fechar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="editProfileForm" onsubmit="saveProfile(event)">
                <div class="space-y-4">
                    <!-- Upload de Foto de Perfil -->
                    <div class="text-center">
                        <div class="mb-4">
                            <div id="currentAvatar" class="w-24 h-24 mx-auto rounded-full bg-gray-300 flex items-center justify-center text-white text-2xl font-bold">
                                UP
                            </div>
                        </div>
                        <div>
                            <label for="profilePhoto" class="block text-sm font-medium text-gray-700 mb-2">Foto de Perfil</label>
                            <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(event)">
                            <button type="button" onclick="document.getElementById('profilePhoto').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                üì∑ Escolher Foto
                            </button>
                            <button type="button" id="removePhotoBtn" onclick="removeProfilePhoto()" class="hidden ml-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                üóëÔ∏è Remover
                            </button>
                            <p class="text-xs text-gray-500 mt-1">M√°ximo 5MB - JPG, PNG ou GIF</p>
                        </div>
                    </div>

                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="editName" name="name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                    </div>

                    <div>
                        <label for="editEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="editEmail" name="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                    </div>

                    <div id="cadasturField" class="hidden">
                        <label for="editCadastur" class="block text-sm font-medium text-gray-700">N√∫mero CADASTUR</label>
                        <input type="text" id="editCadastur" name="cadastur" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Ex: 27123456789">
                        <p id="cadasturHelp" class="text-xs text-gray-500 mt-1">N√∫mero oficial do CADASTUR</p>
                    </div>

                    <div>
                        <label for="editPhone" class="block text-sm font-medium text-gray-700">Telefone</label>
                        <input type="tel" id="editPhone" name="phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="(11) 99999-9999">
                    </div>

                    <div>
                        <label for="editLocation" class="block text-sm font-medium text-gray-700">Localiza√ß√£o</label>
                        <input type="text" id="editLocation" name="location" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Cidade, Estado">
                        <p id="locationHelp" class="text-xs text-gray-500 mt-1">Cidade e estado onde atua</p>
                    </div>

                    <div>
                        <label for="editBio" class="block text-sm font-medium text-gray-700">Biografia</label>
                        <textarea id="editBio" name="bio" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Conte um pouco sobre voc√™ e sua paix√£o por trilhas..."></textarea>
                    </div>

                    <div>
                        <label for="editExperienceLevel" class="block text-sm font-medium text-gray-700">N√≠vel de Experi√™ncia</label>
                        <select id="editExperienceLevel" name="experience_level" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                            <option value="iniciante">üå± Iniciante</option>
                            <option value="intermediario">ü•æ Intermedi√°rio</option>
                            <option value="avancado">üèîÔ∏è Avan√ßado</option>
                            <option value="expert">‚≠ê Expert</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Expedition Modal -->
    <div id="createExpeditionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-3/5 shadow-lg rounded-md bg-white max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Criar nova expedi√ß√£o</h3>
                <button onclick="closeCreateExpeditionModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Fechar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                <button id="expeditionSelectTab" class="flex-1 py-2 px-3 text-sm font-medium rounded-md bg-white text-green-600 shadow-sm" onclick="showCreateExpeditionTab('selection')">
                    Selecionar trilha cadastrada
                </button>
                <button id="expeditionRequestTabBtn" class="flex-1 py-2 px-3 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700" onclick="showCreateExpeditionTab('request')">
                    Solicitar nova trilha
                </button>
            </div>

            <div id="expeditionSelectionTab" class="space-y-4">
                <form id="expeditionTrailSearchForm" class="bg-gray-50 p-4 rounded-lg space-y-4">
                    <h4 class="text-sm font-medium text-gray-900">üîç Busque trilhas dispon√≠veis</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filterUF" class="block text-xs font-medium text-gray-700 mb-1">Estado (UF)</label>
                            <select id="filterUF" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                                <option value="">Todos os Estados</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterCity" class="block text-xs font-medium text-gray-700 mb-1">Cidade</label>
                            <input type="text" id="filterCity" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Digite a cidade...">
                        </div>
                        <div>
                            <label for="filterTrailName" class="block text-xs font-medium text-gray-700 mb-1">Nome da Trilha</label>
                            <input type="text" id="filterTrailName" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Digite o nome da trilha...">
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <button type="button" id="clearTrailFiltersBtn" class="hover:text-gray-700">üóëÔ∏è Limpar filtros</button>
                        <span id="expeditionTrailResultsInfo" class="hidden">0 trilhas encontradas</span>
                    </div>
                </form>

                <div id="expeditionTrailsList" class="space-y-2 max-h-60 overflow-y-auto border border-dashed border-gray-200 rounded-lg p-4">
                    <div class="text-center py-4 text-gray-500">Use os filtros acima para localizar uma trilha na base do Trekko.</div>
                </div>

                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span>As trilhas dispon√≠veis utilizam as bases oficiais BD_TRILHAS e BD_CADASTUR.</span>
                    <button type="button" class="text-green-600 hover:text-green-700" onclick="showCreateExpeditionTab('request')">N√£o encontrou? Solicitar nova trilha</button>
                </div>

                <div id="selectedExpeditionTrail" class="hidden bg-green-50 border border-green-100 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-2">Trilha selecionada</h4>
                    <div id="selectedExpeditionTrailDetails" class="text-sm text-gray-700 space-y-1"></div>
                </div>

                <form id="createExpeditionForm" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="expeditionStartDate" class="block text-sm font-medium text-gray-700">Data de in√≠cio *</label>
                            <input type="date" id="expeditionStartDate" name="start_date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                        </div>
                        <div>
                            <label for="expeditionEndDate" class="block text-sm font-medium text-gray-700">Data de t√©rmino *</label>
                            <input type="date" id="expeditionEndDate" name="end_date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="expeditionPrice" class="block text-sm font-medium text-gray-700">Pre√ßo por pessoa (R$) *</label>
                            <input type="number" id="expeditionPrice" name="price" step="0.01" min="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="0,00" required>
                        </div>
                        <div>
                            <label for="expeditionMaxParticipants" class="block text-sm font-medium text-gray-700">Vagas dispon√≠veis *</label>
                            <input type="number" id="expeditionMaxParticipants" name="max_participants" min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="N√∫mero m√°ximo de participantes" required>
                        </div>
                    </div>

                    <div>
                        <label for="expeditionDescription" class="block text-sm font-medium text-gray-700">Descri√ß√£o da expedi√ß√£o *</label>
                        <textarea id="expeditionDescription" name="description" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Inclua detalhes sobre roteiro, equipamentos necess√°rios e o que est√° incluso." required></textarea>
                    </div>
                </form>
            </div>

            <div id="expeditionRequestTab" class="hidden">
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-blue-800">N√£o encontrou a trilha que deseja conduzir? Solicite a inclus√£o preenchendo as informa√ß√µes abaixo. Nossa equipe validar√° a trilha antes de liber√°-la.</p>
                </div>

                <form id="requestTrailForm" class="space-y-4">
                    <div>
                        <label for="requestTrailName" class="block text-sm font-medium text-gray-700">Nome da Trilha *</label>
                        <input type="text" id="requestTrailName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="requestTrailLocation" class="block text-sm font-medium text-gray-700">Localiza√ß√£o *</label>
                            <input type="text" id="requestTrailLocation" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Cidade, Estado" required>
                        </div>
                        <div>
                            <label for="requestTrailDistance" class="block text-sm font-medium text-gray-700">Dist√¢ncia (km) *</label>
                            <input type="number" id="requestTrailDistance" step="0.1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="requestTrailDifficulty" class="block text-sm font-medium text-gray-700">N√≠vel de Dificuldade *</label>
                            <select id="requestTrailDifficulty" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" required>
                                <option value="">Selecione...</option>
                                <option value="facil">üü¢ F√°cil</option>
                                <option value="moderado">üü° Moderado</option>
                                <option value="dificil">üü† Dif√≠cil</option>
                                <option value="extremo">üî¥ Extremo</option>
                            </select>
                        </div>
                        <div>
                            <label for="requestTrailDuration" class="block text-sm font-medium text-gray-700">Dura√ß√£o Estimada *</label>
                            <input type="text" id="requestTrailDuration" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Ex: 4 horas" required>
                        </div>
                    </div>

                    <div>
                        <label for="requestTrailDescription" class="block text-sm font-medium text-gray-700">Descri√ß√£o da Trilha *</label>
                        <textarea id="requestTrailDescription" rows="4" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Descreva a trilha, pontos de interesse, dificuldades e equipamentos necess√°rios." required></textarea>
                    </div>

                    <div>
                        <label for="requestGuidePrice" class="block text-sm font-medium text-gray-700">Valor do Seu Servi√ßo (R$) *</label>
                        <input type="number" id="requestGuidePrice" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="0.00" required>
                        <p class="text-xs text-gray-500 mt-1">Informe o valor que voc√™ cobra para guiar esta trilha</p>
                    </div>

                    <div>
                        <label for="requestAdditionalInfo" class="block text-sm font-medium text-gray-700">Informa√ß√µes Adicionais</label>
                        <textarea id="requestAdditionalInfo" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Compartilhe detalhes sobre log√≠stica, pontos de encontro ou exig√™ncias espec√≠ficas."></textarea>
                    </div>
                </form>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeCreateExpeditionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="button" id="expeditionModalActionBtn" onclick="handleExpeditionPrimaryAction()" class="px-4 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700">
                    Salvar expedi√ß√£o
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        console.log('üöÄ Sistema de Perfil carregado!');

        const PUBLIC_API_BASE_URL = 'https://p9hwiqcldgkm.manus.space';
        const PUBLIC_API_URL = `${PUBLIC_API_BASE_URL}/api`;
        const EXPEDITION_STORAGE_PREFIX = 'guideExpeditions_';
        const TRAIL_SEARCH_LIMIT = 50;

        let currentUser = null;
        let cachedTrailResults = [];
        let selectedExpeditionTrail = null;
        let expeditionCurrentTab = 'selection';
        let expeditionSearchTimeout = null;

        function normalizeUserType(userType) {
            if (!userType) {
                return 'trekker';
            }

            const normalized = userType.toString().trim().toLowerCase();

            const guideAliases = ['guia', 'guide', 'guia profissional', 'guia_profissional', 'professional guide'];
            const trekkerAliases = ['trekker', 'usu√°rio', 'usuario', 'user', 'cliente'];

            if (guideAliases.includes(normalized)) {
                return 'guia';
            }

            if (trekkerAliases.includes(normalized)) {
                return 'trekker';
            }

            return normalized || 'trekker';
        }

        function isGuide(userOrType) {
            if (!userOrType) return false;
            if (typeof userOrType === 'string') {
                return normalizeUserType(userOrType) === 'guia';
            }
            return normalizeUserType(userOrType.user_type || userOrType.type) === 'guia';
        }

        // Fun√ß√£o para carregar dados do usu√°rio do localStorage
        function loadUserData() {
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    user.user_type = normalizeUserType(user.user_type);
                    console.log('üìä Dados do usu√°rio carregados:', user);
                    return user;
                } catch (e) {
                    console.error('‚ùå Erro ao parsear dados do usu√°rio:', e);
                }
            }

            // Dados padr√£o se n√£o houver usu√°rio
            return {
                id: 'user_default',
                name: 'Usu√°rio Padr√£o',
                email: 'usuario@exemplo.com',
                user_type: 'trekker',
                phone: '',
                location: '',
                bio: 'Apaixonado por trilhas e aventuras na natureza.',
                experience_level: 'iniciante'
            };
        }

        // Vari√°vel global do usu√°rio atual
        currentUser = loadUserData();

        // Fun√ß√£o para atualizar a interface com os dados do usu√°rio
        function updateUserInterface(user) {
            console.log('üé® Atualizando interface para:', user.name, '(Tipo:', user.user_type + ')');
            
            // Atualizar informa√ß√µes b√°sicas
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileBio').textContent = user.bio || 'Sem biografia definida.';
            document.getElementById('userName').textContent = user.name;
            
            // Atualizar avatar principal
            const avatar = document.getElementById('profileAvatar');
            const avatarInitials = document.getElementById('avatarInitials');
            
            if (user.profilePhoto) {
                // Mostrar foto de perfil
                avatar.innerHTML = `<img src="${user.profilePhoto}" alt="Foto de ${user.name}" class="w-full h-full object-cover rounded-full">`;
                console.log('üì∑ Foto de perfil carregada na interface');
            } else {
                // Mostrar iniciais
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                avatar.innerHTML = `<span class="text-white text-3xl font-bold">${initials}</span>`;
            }
            
            // Atualizar avatar no modal de edi√ß√£o
            const currentAvatar = document.getElementById('currentAvatar');
            if (currentAvatar) {
                if (user.profilePhoto) {
                    currentAvatar.innerHTML = `<img src="${user.profilePhoto}" alt="Foto de Perfil" class="w-full h-full object-cover rounded-full">`;
                    document.getElementById('removePhotoBtn').classList.remove('hidden');
                } else {
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    currentAvatar.innerHTML = initials;
                    document.getElementById('removePhotoBtn').classList.add('hidden');
                }
            }
            
            // Atualizar avatar baseado no tipo de usu√°rio
            if (isGuide(user)) {
                avatar.className = 'guide-avatar w-24 h-24 rounded-full flex items-center justify-center text-white text-3xl font-bold';
            } else {
                avatar.className = 'profile-avatar w-24 h-24 rounded-full flex items-center justify-center text-white text-3xl font-bold';
            }
            
            // Atualizar badge do tipo de usu√°rio
            const userTypeBadge = document.getElementById('userTypeBadge');
            const cadasturBadge = document.getElementById('cadasturBadge');
            
            if (isGuide(user)) {
                userTypeBadge.textContent = 'üß≠ Guia Profissional';
                userTypeBadge.className = 'bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium';
                cadasturBadge.classList.remove('hidden');
                
                // Atualizar labels das estat√≠sticas
                document.getElementById('stat1Label').textContent = 'Trilhas Conduzidas';
                document.getElementById('stat3Label').textContent = 'Clientes Atendidos';
                document.getElementById('activitySubtext').textContent = 'Adicione as trilhas que voc√™ conduz.';
                
                // Mostrar bot√µes de cria√ß√£o de expedi√ß√£o
                const primaryExpeditionBtn = document.getElementById('createExpeditionBtn');
                const secondaryExpeditionBtn = document.getElementById('secondaryCreateExpeditionBtn');
                if (primaryExpeditionBtn) primaryExpeditionBtn.classList.remove('hidden');
                if (secondaryExpeditionBtn) secondaryExpeditionBtn.classList.remove('hidden');
            } else {
                userTypeBadge.textContent = 'ü•æ Trekker';
                userTypeBadge.className = 'bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium';
                cadasturBadge.classList.add('hidden');
                
                // Labels padr√£o para trekkers
                document.getElementById('stat1Label').textContent = 'Trilhas Realizadas';
                document.getElementById('stat3Label').textContent = 'Guias Contratados';
                document.getElementById('activitySubtext').textContent = 'Suas atividades aparecer√£o aqui ap√≥s realizar trilhas.';
                
                // Esconder bot√µes de cria√ß√£o de expedi√ß√£o
                const primaryExpeditionBtn = document.getElementById('createExpeditionBtn');
                const secondaryExpeditionBtn = document.getElementById('secondaryCreateExpeditionBtn');
                if (primaryExpeditionBtn) primaryExpeditionBtn.classList.add('hidden');
                if (secondaryExpeditionBtn) secondaryExpeditionBtn.classList.add('hidden');
            }
            
            // Atualizar n√≠vel de experi√™ncia
            const experienceLabels = {
                'iniciante': 'üå± Iniciante',
                'intermediario': 'ü•æ Intermedi√°rio',
                'avancado': 'üèîÔ∏è Avan√ßado',
                'expert': '‚≠ê Expert'
            };
            document.getElementById('experienceLevel').textContent = experienceLabels[user.experience_level] || 'Iniciante';
        }

        async function openEditModal() {
            console.log('üéØ Abrindo modal de editar perfil para:', currentUser.user_type);
            
            const modal = document.getElementById('editProfileModal');
            if (!modal) {
                console.error('‚ùå Modal n√£o encontrado!');
                return;
            }

            // Recarregar dados do usu√°rio do localStorage
            currentUser = loadUserData();

            // Preencher formul√°rio com dados atuais
            document.getElementById('editName').value = currentUser.name || '';
            document.getElementById('editEmail').value = currentUser.email || '';
            document.getElementById('editPhone').value = currentUser.phone || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editExperienceLevel').value = currentUser.experience_level || 'iniciante';
            
            // Mostrar campo CADASTUR apenas para guias
            const cadasturField = document.getElementById('cadasturField');
            const cadasturInput = document.getElementById('editCadastur');
            const locationInput = document.getElementById('editLocation');
            
            if (isGuide(currentUser)) {
                cadasturField.classList.remove('hidden');

                // Para guias, carregar dados do CADASTUR da API
                if (currentUser.cadastur) {
                    console.log('üîç Carregando dados do CADASTUR para guia:', currentUser.cadastur);
                    
                    try {
                        // Buscar dados do guia na API do CADASTUR
                        const response = await fetch(`http://localhost:5000/api/guides?cadastur=${currentUser.cadastur}`);
                        const guides = await response.json();
                        
                        if (guides && guides.length > 0) {
                            const guideData = guides[0];
                            console.log('‚úÖ Dados do CADASTUR carregados:', guideData);
                            
                            // Preencher campos com dados do CADASTUR e torn√°-los read-only
                            cadasturInput.value = guideData.cadastur || currentUser.cadastur;
                            cadasturInput.readOnly = true;
                            cadasturInput.style.backgroundColor = '#f3f4f6';
                            cadasturInput.style.cursor = 'not-allowed';
                            
                            locationInput.value = guideData.location || currentUser.location || '';
                            locationInput.readOnly = true;
                            locationInput.style.backgroundColor = '#f3f4f6';
                            locationInput.style.cursor = 'not-allowed';
                            
                            // Adicionar texto explicativo
                            const cadasturHelp = document.getElementById('cadasturHelp');
                            if (cadasturHelp) {
                                cadasturHelp.textContent = 'üîí Dados oficiais do CADASTUR (n√£o edit√°veis)';
                                cadasturHelp.style.color = '#6b7280';
                            }
                            
                        } else {
                            console.log('‚ö†Ô∏è Guia n√£o encontrado na base CADASTUR');
                            // Permitir edi√ß√£o se n√£o encontrado na base
                            cadasturInput.value = currentUser.cadastur || '';
                            cadasturInput.readOnly = false;
                            locationInput.value = currentUser.location || '';
                            locationInput.readOnly = false;
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao carregar dados do CADASTUR:', error);
                        // Em caso de erro, permitir edi√ß√£o
                        cadasturInput.value = currentUser.cadastur || '';
                        cadasturInput.readOnly = false;
                        locationInput.value = currentUser.location || '';
                        locationInput.readOnly = false;
                    }
                } else {
                    // Se n√£o tem CADASTUR, permitir edi√ß√£o normal
                    cadasturInput.value = '';
                    cadasturInput.readOnly = false;
                    locationInput.value = currentUser.location || '';
                    locationInput.readOnly = false;
                }
            } else {
                cadasturField.classList.add('hidden');
                // Para trekkers, permitir edi√ß√£o normal da localiza√ß√£o
                locationInput.value = currentUser.location || '';
                locationInput.readOnly = false;
                locationInput.style.backgroundColor = '';
                locationInput.style.cursor = '';
            }

            modal.classList.remove('hidden');
            console.log('‚úÖ Modal aberto com sucesso!');
        }

        function closeEditModal() {
            console.log('üîí Fechando modal...');
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function saveProfile(event) {
            event.preventDefault();
            console.log('üíæ Salvando perfil...');

            // Recarregar dados atuais
            currentUser = loadUserData();

            // Obter dados do formul√°rio
            const formData = new FormData(event.target);
            const updatedUser = {
                ...currentUser,
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                location: formData.get('location'),
                bio: formData.get('bio'),
                experience_level: formData.get('experience_level')
            };

            // Processar foto de perfil
            const photoInput = document.getElementById('profilePhoto');
            if (photoInput.files && photoInput.files[0]) {
                const file = photoInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    updatedUser.profilePhoto = e.target.result;
                    console.log('üì∑ Foto de perfil salva');
                    
                    // Continuar com o salvamento
                    finalizeSaveProfile(updatedUser);
                };
                reader.readAsDataURL(file);
            } else {
                // Se n√£o h√° nova foto, manter a existente ou remover se foi removida
                const currentAvatar = document.getElementById('currentAvatar');
                if (currentAvatar.innerHTML.includes('<img')) {
                    // Manter foto existente
                    updatedUser.profilePhoto = currentUser.profilePhoto || null;
                } else {
                    // Foto foi removida
                    updatedUser.profilePhoto = null;
                }
                
                finalizeSaveProfile(updatedUser);
            }
        }

        function finalizeSaveProfile(updatedUser) {
            // Adicionar CADASTUR se for guia
            if (isGuide(currentUser)) {
                updatedUser.cadastur = document.getElementById('editCadastur').value;
            }

            // Salvar no localStorage
            localStorage.setItem('userData', JSON.stringify(updatedUser));
            currentUser = updatedUser;

            // Atualizar interface
            updateUserInterface(currentUser);

            // Fechar modal
            closeEditModal();

            console.log('‚úÖ Perfil salvo com sucesso!', currentUser);
            alert('Perfil atualizado com sucesso!');
        }

        // Configurar tabs
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');

                    // Remover classes ativas
                    tabBtns.forEach(b => {
                        b.classList.remove('border-green-500', 'text-green-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });

                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });

                    // Adicionar classes ativas
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-green-500', 'text-green-600');

                    // Mostrar conte√∫do alvo
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ P√°gina carregada, inicializando sistema universal...');
            
            // Carregar dados do usu√°rio e atualizar interface
            currentUser = loadUserData();
            updateUserInterface(currentUser);
            
            // Configurar tabs
            setupTabs();

            // Preparar busca de trilhas para expedi√ß√µes
            setupExpeditionSearch();

            // Carregar trilhas do usu√°rio se for guia
            loadUserTrails();
            
            console.log('‚úÖ Sistema universal inicializado com sucesso!');
        });

        // Fechar modal ao clicar fora
        window.addEventListener('click', function(event) {
            const editModal = document.getElementById('editProfileModal');
            if (event.target === editModal) {
                closeEditModal();
            }

            const expeditionModal = document.getElementById('createExpeditionModal');
            if (event.target === expeditionModal) {
                closeCreateExpeditionModal();
            }
        });

        function openCreateExpeditionModal() {
            console.log('üéØ Abrindo modal de cria√ß√£o de expedi√ß√£o...');
            if (!isGuide(currentUser)) {
                alert('A cria√ß√£o de expedi√ß√µes est√° dispon√≠vel apenas para guias credenciados.');
                return;
            }

            const modal = document.getElementById('createExpeditionModal');
            if (!modal) {
                console.warn('‚ö†Ô∏è Modal de expedi√ß√£o n√£o encontrado.');
                return;
            }

            currentUser = loadUserData();
            resetExpeditionModal();
            modal.classList.remove('hidden');
            triggerTrailSearch();
        }

        function closeCreateExpeditionModal() {
            const modal = document.getElementById('createExpeditionModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function resetExpeditionModal() {
            selectedExpeditionTrail = null;
            cachedTrailResults = [];

            const form = document.getElementById('createExpeditionForm');
            const selectedWrapper = document.getElementById('selectedExpeditionTrail');
            const selectedDetails = document.getElementById('selectedExpeditionTrailDetails');
            const trailList = document.getElementById('expeditionTrailsList');
            const info = document.getElementById('expeditionTrailResultsInfo');

            if (form) {
                form.reset();
                form.classList.add('hidden');
            }

            if (selectedWrapper) {
                selectedWrapper.classList.add('hidden');
            }

            if (selectedDetails) {
                selectedDetails.innerHTML = '';
            }

            if (trailList) {
                trailList.innerHTML = '<div class="text-center py-4 text-gray-500">Use os filtros acima para localizar uma trilha na base do Trekko.</div>';
            }

            if (info) {
                info.classList.add('hidden');
                info.textContent = '';
            }

            showCreateExpeditionTab('selection');
        }

        function showCreateExpeditionTab(tab) {
            expeditionCurrentTab = tab;

            const selectionTab = document.getElementById('expeditionSelectionTab');
            const requestTab = document.getElementById('expeditionRequestTab');
            const selectBtn = document.getElementById('expeditionSelectTab');
            const requestBtn = document.getElementById('expeditionRequestTabBtn');
            const actionBtn = document.getElementById('expeditionModalActionBtn');

            if (tab === 'selection') {
                if (selectionTab) selectionTab.classList.remove('hidden');
                if (requestTab) requestTab.classList.add('hidden');
                if (selectBtn) {
                    selectBtn.classList.add('bg-white', 'text-green-600', 'shadow-sm');
                    selectBtn.classList.remove('text-gray-500');
                }
                if (requestBtn) {
                    requestBtn.classList.remove('bg-white', 'text-green-600', 'shadow-sm');
                    requestBtn.classList.add('text-gray-500');
                }
                if (actionBtn) actionBtn.textContent = 'Salvar expedi√ß√£o';
            } else {
                if (selectionTab) selectionTab.classList.add('hidden');
                if (requestTab) requestTab.classList.remove('hidden');
                if (requestBtn) {
                    requestBtn.classList.add('bg-white', 'text-green-600', 'shadow-sm');
                    requestBtn.classList.remove('text-gray-500');
                }
                if (selectBtn) {
                    selectBtn.classList.remove('bg-white', 'text-green-600', 'shadow-sm');
                    selectBtn.classList.add('text-gray-500');
                }
                if (actionBtn) actionBtn.textContent = 'Enviar solicita√ß√£o';
            }
        }

        function setupExpeditionSearch() {
            const ufSelect = document.getElementById('filterUF');
            const cityInput = document.getElementById('filterCity');
            const trailInput = document.getElementById('filterTrailName');
            const clearBtn = document.getElementById('clearTrailFiltersBtn');
            const searchForm = document.getElementById('expeditionTrailSearchForm');

            [ufSelect, cityInput, trailInput].forEach(input => {
                if (!input) return;
                const eventName = input.tagName === 'SELECT' ? 'change' : 'input';
                input.addEventListener(eventName, triggerTrailSearch);
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (ufSelect) ufSelect.value = '';
                    if (cityInput) cityInput.value = '';
                    if (trailInput) trailInput.value = '';
                    triggerTrailSearch();
                });
            }

            if (searchForm) {
                searchForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    triggerTrailSearch();
                });
            }
        }

        function triggerTrailSearch() {
            if (expeditionSearchTimeout) {
                clearTimeout(expeditionSearchTimeout);
            }

            expeditionSearchTimeout = setTimeout(() => {
                const ufField = document.getElementById('filterUF');
                const cityField = document.getElementById('filterCity');
                const nameField = document.getElementById('filterTrailName');

                const filters = {
                    uf: ufField ? ufField.value : '',
                    city: cityField ? cityField.value : '',
                    name: nameField ? nameField.value : ''
                };
                performTrailSearch(filters);
            }, 300);
        }

        async function performTrailSearch(filters = {}) {
            const list = document.getElementById('expeditionTrailsList');
            const info = document.getElementById('expeditionTrailResultsInfo');

            if (!list) return;

            list.innerHTML = '<div class="text-center py-4 text-gray-500">Buscando trilhas cadastradas...</div>';

            const params = new URLSearchParams();
            params.append('limit', TRAIL_SEARCH_LIMIT);
            if (filters.uf) params.append('state', filters.uf);
            if (filters.city) params.append('city', filters.city);
            if (filters.name) params.append('search', filters.name);

            try {
                const response = await fetch(`${PUBLIC_API_URL}/trails?${params.toString()}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const payload = await response.json();
                let trails = [];
                if (payload && Array.isArray(payload.trails)) {
                    trails = payload.trails;
                } else if (payload && Array.isArray(payload.data)) {
                    trails = payload.data;
                }

                cachedTrailResults = trails;
                renderTrailResults(trails);
                if (info) {
                    info.classList.remove('hidden');
                    info.textContent = `${trails.length} trilha${trails.length === 1 ? '' : 's'} encontrada${trails.length === 1 ? '' : 's'}`;
                }
            } catch (error) {
                console.error('‚ùå Erro ao buscar trilhas cadastradas:', error);
                cachedTrailResults = [];
                list.innerHTML = '<div class="text-center py-4 text-red-500">N√£o foi poss√≠vel carregar as trilhas agora. Tente novamente em instantes.</div>';
                if (info) info.classList.add('hidden');
            }
        }

        function renderTrailResults(trails) {
            const list = document.getElementById('expeditionTrailsList');
            if (!list) return;

            if (!trails.length) {
                list.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhuma trilha encontrada com os filtros informados.</div>';
                return;
            }

            list.innerHTML = trails.map(trail => {
                const distance = trail.distance || trail.total_distance_km || trail.km || 0;
                const duration = trail.duration || trail.average_duration || trail.time || 'Dura√ß√£o n√£o informada';
                const difficulty = trail.difficulty || trail.level || 'moderado';
                const city = trail.city || (trail.location ? trail.location.split(',')[0] : '');
                const state = trail.state || trail.uf || (trail.location ? trail.location.split(',')[1] : '');
                const locationLabel = trail.location || `${city}${state ? ', ' + state.trim() : ''}`;

                return `
                    <button type="button" class="w-full text-left border border-gray-200 rounded-lg p-4 hover:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-500 transition" data-trail-id="${trail.id}">
                        <div class="flex items-start justify-between">
                            <div>
                                <h5 class="text-sm font-semibold text-gray-900">${trail.name}</h5>
                                <p class="text-xs text-gray-500">üìç ${locationLabel || 'Local n√£o informado'}</p>
                            </div>
                            <span class="text-xs font-medium text-green-600">Selecionar</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1">
                            <span>üìè ${Number(distance).toFixed(1)} km</span>
                            <span>‚è±Ô∏è ${duration}</span>
                            <span>${getDifficultyIcon(difficulty)} ${getDifficultyLabel(difficulty)}</span>
                        </div>
                    </button>
                `;
            }).join('');

            const buttons = list.querySelectorAll('button[data-trail-id]');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const trailId = button.getAttribute('data-trail-id');
                    selectTrailForExpedition(trailId);
                });
            });
        }

        function selectTrailForExpedition(trailId) {
            if (!trailId) return;
            const trail = cachedTrailResults.find(item => String(item.id) === String(trailId));
            if (!trail) return;

            selectedExpeditionTrail = trail;
            updateSelectedTrailView();
            prepareExpeditionForm();
        }

        function updateSelectedTrailView() {
            const wrapper = document.getElementById('selectedExpeditionTrail');
            const details = document.getElementById('selectedExpeditionTrailDetails');

            if (!wrapper || !details) return;

            if (!selectedExpeditionTrail) {
                wrapper.classList.add('hidden');
                details.innerHTML = '';
                return;
            }

            const distance = selectedExpeditionTrail.distance || selectedExpeditionTrail.total_distance_km || selectedExpeditionTrail.km || 0;
            const duration = selectedExpeditionTrail.duration || selectedExpeditionTrail.average_duration || selectedExpeditionTrail.time || 'Dura√ß√£o n√£o informada';
            const difficulty = selectedExpeditionTrail.difficulty || selectedExpeditionTrail.level || 'moderado';
            const city = selectedExpeditionTrail.city || (selectedExpeditionTrail.location ? selectedExpeditionTrail.location.split(',')[0] : '');
            const state = selectedExpeditionTrail.state || selectedExpeditionTrail.uf || (selectedExpeditionTrail.location ? selectedExpeditionTrail.location.split(',')[1] : '');
            const locationLabel = selectedExpeditionTrail.location || `${city}${state ? ', ' + state.trim() : ''}`;

            details.innerHTML = `
                <div class="bg-white border border-green-200 rounded-md p-3">
                    <h5 class="text-sm font-semibold text-gray-900">${selectedExpeditionTrail.name}</h5>
                    <p class="text-xs text-gray-500">üìç ${locationLabel || 'Local n√£o informado'}</p>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-600 mt-2">
                        <span>üìè ${Number(distance).toFixed(1)} km</span>
                        <span>‚è±Ô∏è ${duration}</span>
                        <span>${getDifficultyIcon(difficulty)} ${getDifficultyLabel(difficulty)}</span>
                    </div>
                    ${selectedExpeditionTrail.description ? `<p class="mt-2 text-xs text-gray-600 leading-relaxed">${selectedExpeditionTrail.description}</p>` : ''}
                </div>
            `;

            wrapper.classList.remove('hidden');
        }

        function prepareExpeditionForm() {
            const form = document.getElementById('createExpeditionForm');
            if (!form) return;

            form.classList.remove('hidden');

            const startInput = document.getElementById('expeditionStartDate');
            const endInput = document.getElementById('expeditionEndDate');
            const today = new Date().toISOString().split('T')[0];

            if (startInput && !startInput.value) {
                startInput.value = today;
            }

            if (endInput && !endInput.value) {
                endInput.value = today;
            }

            if (startInput) startInput.focus();
        }

        function handleExpeditionPrimaryAction() {
            if (expeditionCurrentTab === 'request') {
                submitTrailRequest();
            } else {
                handleExpeditionSave();
            }
        }

        async function handleExpeditionSave() {
            if (!selectedExpeditionTrail) {
                alert('Selecione uma trilha cadastrada antes de salvar a expedi√ß√£o.');
                return;
            }

            const form = document.getElementById('createExpeditionForm');
            if (!form) return;

            if (!form.reportValidity()) {
                return;
            }

            const startDate = document.getElementById('expeditionStartDate').value;
            const endDate = document.getElementById('expeditionEndDate').value;
            const price = parseFloat(document.getElementById('expeditionPrice').value);
            const maxParticipants = parseInt(document.getElementById('expeditionMaxParticipants').value, 10);
            const description = document.getElementById('expeditionDescription').value.trim();

            if (new Date(endDate) < new Date(startDate)) {
                alert('A data de t√©rmino deve ser igual ou posterior √† data de in√≠cio.');
                return;
            }

            if (Number.isNaN(price) || price <= 0) {
                alert('Informe um pre√ßo v√°lido para a expedi√ß√£o.');
                return;
            }

            if (Number.isNaN(maxParticipants) || maxParticipants <= 0) {
                alert('Informe o n√∫mero m√°ximo de participantes da expedi√ß√£o.');
                return;
            }

            const locationParts = (selectedExpeditionTrail.location || '').split(',');
            const city = (selectedExpeditionTrail.city || locationParts[0] || '').trim();
            const state = (selectedExpeditionTrail.state || selectedExpeditionTrail.uf || locationParts[1] || '').trim();

            const expedition = {
                id: `expedition_${Date.now()}`,
                guide_id: currentUser.id,
                guide_name: currentUser.name,
                trail_id: selectedExpeditionTrail.id,
                trail_name: selectedExpeditionTrail.name,
                trail_location: selectedExpeditionTrail.location || `${city}${state ? ', ' + state : ''}`,
                city,
                state,
                start_date: startDate,
                end_date: endDate,
                price,
                max_participants: maxParticipants,
                description,
                created_at: new Date().toISOString(),
                storage: 'local'
            };

            await persistExpedition(expedition);
            closeCreateExpeditionModal();
            loadGuideExpeditions();
            alert('Expedi√ß√£o criada com sucesso! Ela aparecer√° automaticamente na sua lista.');
        }

        async function persistExpedition(expedition) {
            const token = currentUser && (currentUser.token || currentUser.access_token || currentUser.jwt);
            let savedViaApi = false;
            let expeditionToSave = { ...expedition };

            if (token) {
                try {
                    const payload = {
                        trail_id: expedition.trail_id,
                        start_date: expedition.start_date,
                        end_date: expedition.end_date,
                        price_per_person: expedition.price,
                        max_people: expedition.max_participants,
                        description: expedition.description,
                        status: 'draft'
                    };

                    const response = await fetch(`${PUBLIC_API_URL}/expeditions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const apiExpedition = data && (data.expedition || data.data);
                        if (apiExpedition) {
                            expeditionToSave = {
                                ...expeditionToSave,
                                id: apiExpedition.id || expeditionToSave.id,
                                storage: 'api',
                                api_payload: apiExpedition
                            };
                            savedViaApi = true;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel salvar a expedi√ß√£o na API. Status:', response.status);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao tentar integrar com a API de expedi√ß√µes:', error);
                }
            }

            saveExpeditionLocally(expeditionToSave, savedViaApi);
            return expeditionToSave;
        }

        function saveExpeditionLocally(expedition, synced = false) {
            try {
                const key = `${EXPEDITION_STORAGE_PREFIX}${currentUser.id}`;
                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                const record = {
                    ...expedition,
                    storage: synced ? 'api' : 'local',
                    updated_at: new Date().toISOString()
                };

                const index = existing.findIndex(item => item.id === record.id);
                if (index >= 0) {
                    existing[index] = record;
                } else {
                    existing.push(record);
                }

                localStorage.setItem(key, JSON.stringify(existing));
                console.log('üíæ Expedi√ß√£o salva localmente:', record);
            } catch (error) {
                console.error('‚ùå Erro ao salvar expedi√ß√£o no localStorage:', error);
            }
        }

        function loadGuideExpeditions() {
            const section = document.getElementById('guideExpeditionsSection');
            const list = document.getElementById('guideExpeditionsList');
            const primaryBtn = document.getElementById('createExpeditionBtn');
            const secondaryBtn = document.getElementById('secondaryCreateExpeditionBtn');

            if (!isGuide(currentUser)) {
                if (primaryBtn) primaryBtn.classList.add('hidden');
                if (secondaryBtn) secondaryBtn.classList.add('hidden');
                if (section) section.classList.add('hidden');
                if (list) list.innerHTML = '';
                return;
            }

            if (primaryBtn) primaryBtn.classList.remove('hidden');
            if (secondaryBtn) secondaryBtn.classList.remove('hidden');
            if (section) section.classList.remove('hidden');

            if (!list) {
                return;
            }

            const key = `${EXPEDITION_STORAGE_PREFIX}${currentUser.id}`;
            const expeditions = JSON.parse(localStorage.getItem(key) || '[]');

            if (!expeditions.length) {
                list.innerHTML = `
                    <div class="text-center text-sm text-gray-500 bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <p class="font-medium text-gray-700 mb-1">Nenhuma expedi√ß√£o cadastrada ainda.</p>
                        <p class="text-xs text-gray-500">Clique em ‚Äú+ Criar Expedi√ß√£o‚Äù para planejar a sua primeira aventura.</p>
                    </div>
                `;
                return;
            }

            expeditions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            list.innerHTML = expeditions.map(renderExpeditionCard).join('');
        }

        function renderExpeditionCard(expedition) {
            const start = expedition.start_date ? new Date(expedition.start_date) : null;
            const end = expedition.end_date ? new Date(expedition.end_date) : null;
            const dateFormatter = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: 'short' });
            const dateLabel = start && end ? `${dateFormatter.format(start)} - ${dateFormatter.format(end)}` : 'Datas a definir';

            return `
                <article class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-base font-semibold text-gray-900">${expedition.trail_name}</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${expedition.storage === 'api' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${expedition.storage === 'api' ? 'Sincronizado' : 'Rascunho local'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">üìç ${expedition.trail_location || 'Local n√£o informado'}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                        <span>üìÖ ${dateLabel}</span>
                        <span>üë• M√°x. ${expedition.max_participants} participante${expedition.max_participants === 1 ? '' : 's'}</span>
                        <span>üí∞ R$ ${Number(expedition.price || 0).toFixed(2)}</span>
                        <span>üïí Criada em ${new Date(expedition.created_at).toLocaleDateString('pt-BR')}</span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed">${expedition.description}</p>
                </article>
            `;
        }

        // Fun√ß√£o para enviar solicita√ß√£o de nova trilha (ser√° implementada na pr√≥xima fase)
        function submitTrailRequest() {
            if (expeditionCurrentTab !== 'request') {
                showCreateExpeditionTab('request');
            }

            const requiredFields = [
                'requestTrailName',
                'requestTrailLocation',
                'requestTrailDistance',
                'requestTrailDifficulty',
                'requestTrailDuration',
                'requestTrailDescription',
                'requestGuidePrice'
            ];

            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios.');
                    if (field) field.focus();
                    return;
                }
            }

            const requestData = {
                guide_name: currentUser.name,
                guide_email: currentUser.email,
                guide_cadastur: currentUser.cadastur,
                trail_name: document.getElementById('requestTrailName').value,
                trail_location: document.getElementById('requestTrailLocation').value,
                trail_distance: document.getElementById('requestTrailDistance').value,
                trail_difficulty: document.getElementById('requestTrailDifficulty').value,
                trail_duration: document.getElementById('requestTrailDuration').value,
                trail_description: document.getElementById('requestTrailDescription').value,
                guide_price: document.getElementById('requestGuidePrice').value,
                additional_info: document.getElementById('requestAdditionalInfo').value,
                request_date: new Date().toISOString()
            };

            sendTrailRequestEmail(requestData);
        }

        // Fun√ß√£o para enviar solicita√ß√£o de nova trilha via email
        function sendTrailRequestEmail(requestData) {
            console.log('üìß Enviando solicita√ß√£o de trilha por email...', requestData);
            
            // Preparar dados do email
            const emailData = {
                to: 'contato@trekko.com.br',
                subject: `Solicita√ß√£o de Nova Trilha - ${requestData.trail_name}`,
                body: `
                    <h2>Nova Solicita√ß√£o de Trilha</h2>
                    
                    <h3>Dados do Guia:</h3>
                    <ul>
                        <li><strong>Nome:</strong> ${requestData.guide_name}</li>
                        <li><strong>Email:</strong> ${requestData.guide_email}</li>
                        <li><strong>CADASTUR:</strong> ${requestData.guide_cadastur || 'N√£o informado'}</li>
                    </ul>
                    
                    <h3>Dados da Trilha Solicitada:</h3>
                    <ul>
                        <li><strong>Nome:</strong> ${requestData.trail_name}</li>
                        <li><strong>Localiza√ß√£o:</strong> ${requestData.trail_location}</li>
                        <li><strong>Dist√¢ncia:</strong> ${requestData.trail_distance} km</li>
                        <li><strong>Dificuldade:</strong> ${getDifficultyLabel(requestData.trail_difficulty)}</li>
                        <li><strong>Dura√ß√£o:</strong> ${requestData.trail_duration}</li>
                        <li><strong>Valor do Servi√ßo:</strong> R$ ${parseFloat(requestData.guide_price).toFixed(2)}</li>
                    </ul>
                    
                    <h3>Descri√ß√£o da Trilha:</h3>
                    <p>${requestData.trail_description}</p>
                    
                    ${requestData.additional_info ? `
                    <h3>Informa√ß√µes Adicionais:</h3>
                    <p>${requestData.additional_info}</p>
                    ` : ''}
                    
                    <hr>
                    <p><small>Solicita√ß√£o enviada em: ${new Date(requestData.request_date).toLocaleString('pt-BR')}</small></p>
                `
            };
            
            // Simular envio de email (em produ√ß√£o seria integra√ß√£o com servi√ßo de email)
            simulateEmailSend(emailData)
                .then(result => {
                    if (result.success) {
                        console.log('‚úÖ Email enviado com sucesso!');
                        
                        // Salvar solicita√ß√£o no localStorage para hist√≥rico
                        saveTrailRequest(requestData);
                        
                        // Fechar modal e mostrar sucesso
                        closeCreateExpeditionModal();
                        
                        alert('Solicita√ß√£o enviada com sucesso! Nossa equipe analisar√° e entrar√° em contato em at√© 48 horas.');
                        
                        // Limpar formul√°rio
                        document.getElementById('requestTrailForm').reset();
                        
                    } else {
                        throw new Error(result.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao enviar email:', error);
                    alert('Erro ao enviar solicita√ß√£o. Tente novamente ou entre em contato diretamente pelo email contato@trekko.com.br');
                });
        }
        
        // Fun√ß√£o para simular envio de email (em produ√ß√£o seria substitu√≠da por integra√ß√£o real)
        function simulateEmailSend(emailData) {
            return new Promise((resolve) => {
                // Simular delay de envio
                setTimeout(() => {
                    console.log('üìß Email simulado enviado:', emailData);
                    resolve({ success: true, messageId: 'sim_' + Date.now() });
                }, 1500);
            });
        }
        
        // Fun√ß√£o para salvar solicita√ß√£o no hist√≥rico local
        function saveTrailRequest(requestData) {
            try {
                let requests = JSON.parse(localStorage.getItem('trailRequests_' + currentUser.id)) || [];
                
                const requestRecord = {
                    ...requestData,
                    id: 'request_' + Date.now(),
                    status: 'enviado',
                    sent_at: new Date().toISOString()
                };
                
                requests.push(requestRecord);
                localStorage.setItem('trailRequests_' + currentUser.id, JSON.stringify(requests));
                
                console.log('üíæ Solicita√ß√£o salva no hist√≥rico:', requestRecord);
            } catch (error) {
                console.error('‚ùå Erro ao salvar solicita√ß√£o:', error);
            }
        }

        function saveTrail(event) {
            // Esta fun√ß√£o n√£o √© mais usada, mas mantida para compatibilidade
            console.log('‚ö†Ô∏è Fun√ß√£o saveTrail descontinuada - use o novo sistema de sele√ß√£o');
        }

        // Carregar trilhas do usu√°rio
        function loadUserTrails() {
            console.log('üì• Carregando trilhas do usu√°rio...');

            currentUser = loadUserData();

            const primaryBtn = document.getElementById('createExpeditionBtn');
            const secondaryBtn = document.getElementById('secondaryCreateExpeditionBtn');
            const activitiesContainer = document.getElementById('activitiesContainer');

            if (!isGuide(currentUser)) {
                console.log('‚ÑπÔ∏è Usu√°rio n√£o √© guia, ocultando recursos de expedi√ß√£o');
                if (primaryBtn) primaryBtn.classList.add('hidden');
                if (secondaryBtn) secondaryBtn.classList.add('hidden');
                if (activitiesContainer) {
                    activitiesContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">ü•æ</div>
                            <p>Nenhuma atividade registrada ainda.</p>
                            <p class="text-sm mt-1">Salve trilhas favoritas ou reserve expedi√ß√µes para v√™-las aqui.</p>
                        </div>
                    `;
                }
                loadGuideExpeditions();
                return;
            }

            if (primaryBtn) primaryBtn.classList.remove('hidden');
            if (secondaryBtn) secondaryBtn.classList.remove('hidden');

            const userTrails = JSON.parse(localStorage.getItem('userTrails_' + currentUser.id)) || [];

            if (!activitiesContainer) {
                loadGuideExpeditions();
                return;
            }

            if (userTrails.length === 0) {
                activitiesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üèîÔ∏è</div>
                        <p>Nenhuma trilha cadastrada ainda.</p>
                        <p class="text-sm mt-1">Use o bot√£o ‚Äú+ Criar Expedi√ß√£o‚Äù para registrar suas aventuras guiadas.</p>
                    </div>
                `;
            } else {
                const trailsHtml = userTrails.map(trail => `
                    <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900">${trail.trail_name || trail.name}</h4>
                            <span class="text-xs text-gray-500">${new Date(trail.created_at).toLocaleDateString('pt-BR')}</span>
                        </div>

                        <div class="flex items-center space-x-4 text-sm text-gray-600 mb-2">
                            <span>üìç ${trail.trail_location || trail.location}</span>
                            <span>üìè ${trail.trail_distance || trail.distance}km</span>
                            <span>${getDifficultyIcon(trail.trail_difficulty || trail.difficulty)} ${getDifficultyLabel(trail.trail_difficulty || trail.difficulty)}</span>
                        </div>

                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">‚è±Ô∏è ${trail.trail_duration || trail.duration}</span>
                            <span class="font-medium text-green-600">R$ ${(trail.guide_price || trail.price || 0).toFixed(2)}</span>
                        </div>

                        <p class="text-sm text-gray-700 mt-2">${trail.trail_description || trail.description}</p>
                    </div>
                `).join('');

                activitiesContainer.innerHTML = trailsHtml;
            }

            loadGuideExpeditions();
            console.log('‚úÖ Trilhas carregadas:', userTrails.length);
        }

        // Fun√ß√µes auxiliares
        function getDifficultyIcon(difficulty) {
            const icons = {
                'facil': 'üü¢',
                'moderado': 'üü°',
                'dificil': 'üü†',
                'extremo': 'üî¥'
            };
            return icons[difficulty] || '‚ö™';
        }

        function getDifficultyLabel(difficulty) {
            const labels = {
                'facil': 'F√°cil',
                'moderado': 'Moderado',
                'dificil': 'Dif√≠cil',
                'extremo': 'Extremo'
            };
            return labels[difficulty] || 'N√£o definido';
        }

        // Fun√ß√µes de upload de foto de perfil
        function previewProfilePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tamanho do arquivo (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('A foto deve ter no m√°ximo 5MB.');
                event.target.value = '';
                return;
            }

            // Validar tipo de arquivo
            if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                alert('Por favor, selecione uma imagem v√°lida (JPG, PNG ou GIF).');
                event.target.value = '';
                return;
            }

            // Criar preview da foto
            const reader = new FileReader();
            reader.onload = function(e) {
                const currentAvatar = document.getElementById('currentAvatar');
                const removeBtn = document.getElementById('removePhotoBtn');
                
                // Substituir avatar por imagem
                currentAvatar.innerHTML = `<img src="${e.target.result}" alt="Foto de Perfil" class="w-full h-full object-cover rounded-full">`;
                
                // Mostrar bot√£o de remover
                removeBtn.classList.remove('hidden');
                
                console.log('üì∑ Preview da foto de perfil carregado');
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePhoto() {
            const currentAvatar = document.getElementById('currentAvatar');
            const photoInput = document.getElementById('profilePhoto');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            // Restaurar avatar com iniciais
            const user = loadUserData();
            const initials = user ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'UP';
            currentAvatar.innerHTML = initials;
            
            // Limpar input e ocultar bot√£o
            photoInput.value = '';
            removeBtn.classList.add('hidden');
            
            console.log('üóëÔ∏è Foto de perfil removida');
        }

        // Preview de fotos
        document.addEventListener('change', function(event) {
            if (event.target.id === 'trailPhotos') {
                const files = Array.from(event.target.files);
                const preview = document.getElementById('photoPreview');
                
                if (files.length > 0) {
                    preview.classList.remove('hidden');
                    preview.innerHTML = files.map((file, index) => {
                        const url = URL.createObjectURL(file);
                        return `
                            <div class="relative">
                                <img src="${url}" class="w-full h-24 object-cover rounded" alt="${file.name}">
                                <button type="button" onclick="removePhoto(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                                    √ó
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    preview.classList.add('hidden');
                }
            }
        });

        function removePhoto(index) {
            const input = document.getElementById('trailPhotos');
            const dt = new DataTransfer();
            const files = Array.from(input.files);
            
            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        }

        console.log('üéâ Sistema Universal de Perfil totalmente funcional!');
    </script>
</body>
</html>

